学习笔记

## 应用 animation 和 gesture 改写 Carousel

- 第 13, 14 周课程分别实现的 animation 和 gesture 可以看作是独立的组件，分别封装了不同方面的复杂性，可以应用在 Carousel 组件上
- 理想情况下，独立组件最好是配备单元测试、lint 等代码质量控制设施
- 组件的 state 只在 render 内部使用的情况下，可以用局部变量来充当（而不是引入状态管理机制）

- 引入 gesture
  - gesture 的 pan 事件响应，加入原 mousemove 事件响应的业务逻辑
  - gesture 的 panend 事件响应，加入原 mouseup 事件响应的业务逻辑
- 引入 Animation
  - 初始化一个 Timeline 对象实例
  - 对当前帧和下一帧图片分别创建 Animation 对象实例，负责控制滑动位置
- 解决拖拽与动画并存带来的问题
  - 任何点击(无论是否拖拽)后应暂停动画 - gesture 增加 start 事件，timeline.pause()
  - 滑动动画过程中暂停，再拖拽时位置不正确
    - 拖拽开始时需要把动画过程产生的位移计算在内
    - 记录最近一次动画开始的时间，拖拽开始时根据当前时间与动画开始时间的差值，计算已产生的位移
  - 暂停时还需要取消 setInterval 内代码执行
    - 记录 setInterval() 返回的 handle，响应 gesture 的 start 事件时取消
    - 把 setInterval() 内执行的函数提取、命名，以便后面恢复自动滑动
  - 拖拽结束时，判定视口中占多数面积的图片，启动动画移动该帧及前后帧图片滑动归位(week13 代码这里是设置滑动起始位置，然后在 setInterval 中开始执行 CSS 动画)
  - 拖拽结束后，重新启动自动周期性滑动
    - 问题：是否需要等待上一步添加的复位动画完成后再启动？
    - TODO 仍然存在 bug：
      - 有时会出现图片拖不动，鼠标指针变为禁止拖拽图标，松开鼠标后自动滑动也不再恢复；此时单击一次后可以再拖拽，随后自动滑动恢复运行
      - 自动滑动期间单击一次，暂停后未复位，也未重新自动滑动；此时拖拽一下可恢复
- 增加 flick 事件的处理
  - 目标：flick 动作后，即使移动距离不足图片宽度一半，也顺着滑动方向移动到下一帧
    - TODO 视频演示代码中计算 direction 逻辑判断了 velocity 的正负，从我现有的代码来看 velocity 始终为正，怀疑应该是看滑动起止点间距 x 的正负。视频演示操作时往右 flick 也没有成功。等以后有时间再研究。
    - TODO 目前代码容易出现只 start，没拖动的情况；鼠标模拟 flick 动作容易失败；还需要进一步测试检查。
- 鼠标单击后未移动就松开的情况，gesture 增加 end 事件，解决前述滑动过程中单击且不移动就松开，图片未复位的问题。
